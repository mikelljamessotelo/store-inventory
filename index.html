<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Store Inventory ‚Äî Version 3.2.8a (Numeric Controls Fixed)</title>
<style>
  :root{
    --bg:#f6f6f6;
    --panel:#fff;
    --txt:#111;
    --muted:#555;
    --accent:#2e7d32;
    --danger:#d32f2f;
    --input-border:#bbb;
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial;
  }
  body{margin:0;padding:14px;background:var(--bg);color:var(--txt);transition:background .22s,color .22s}
  header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .controls{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{background:var(--panel);border:1px solid #222;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:14px}
  button:disabled{opacity:.5;cursor:not-allowed}
  .view{display:none}
  .view.active{display:block}
  table{width:100%;border-collapse:collapse;background:var(--panel)}
  th,td{border:1px solid #222;padding:10px;text-align:left;font-size:15px;vertical-align:middle}
  th.sortable{cursor:pointer}
  tr.selected{background:#fff8d6}
  .topbar{display:flex;gap:8px;margin-bottom:8px;align-items:center}
  .search{flex:1;display:flex;gap:8px;align-items:center}
  input[type=text],input[type=number],select,textarea{padding:8px;border-radius:8px;border:1px solid var(--input-border);width:100%;box-sizing:border-box}
  input.sell-input{background:#fff9c4}
  input[readonly].borderless{border:none;background:transparent;box-shadow:none;padding:8px}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:var(--panel);padding:16px;border-radius:10px;min-width:320px;max-width:920px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn-row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;align-items:center}
  .btn-save{background:var(--accent);color:#fff;border:1px solid rgba(0,0,0,.12);padding:10px 18px;border-radius:8px;font-weight:600}
  .btn-save.wide{min-width:120px}
  .btn-danger{background:#ffebee;border:1px solid var(--danger);color:var(--danger);padding:8px 12px;border-radius:8px}
  .note{font-size:12px;color:var(--muted)}
  .notes-td textarea{width:100%;height:44px;border-radius:6px;border:1px solid #ccc;padding:6px}
  .purchase-top{display:flex;gap:8px;align-items:center;margin-bottom:8px;justify-content:space-between}
  .purchase-title{font-weight:700}
  .no-print{display:block}
  .note-print{display:none}
  .touch-check{display:flex;align-items:center;justify-content:center;width:92px;height:40px}
  .table-wrap{overflow:auto;max-height:calc(100vh - 220px)}
  table thead th{position:sticky;top:0;background:var(--panel);z-index:3}
  .center{text-align:center}
  .negative{color:var(--danger)}
  .sell-bold{font-weight:700}
  @media (max-width:700px){.form-grid{grid-template-columns:1fr}th,td{font-size:14px;padding:8px} }
  @media print{
    header,.controls,.topbar,.no-print{display:none!important}
    body{margin:0;padding:4px;font-size:13.5px;background:#fff !important;color:#000 !important; font-family: "Courier New", Courier, monospace !important;}
    #purchaseContainer{margin:0 auto; width:95%; background: #fff !important;}
    #purchaseContainer table{width:100%; border-collapse:collapse; border:none; background:transparent}
    #purchaseContainer th,#purchaseContainer td{
      border: none !important;
      padding: 2px 0 !important;
      font-size:13.5px;
      text-align:left;
      vertical-align:top;
    }
    #purchaseContainer thead th{font-weight:700; padding-bottom:6px}
    .note-print{display:block;padding:2px 0;border:0}
    textarea.note-input{display:none!important}
    @page { margin: 8mm 6mm; }
    .purchase-summary { display: none !important; }
    .print-total-row { display: table-row !important; }
  }
  body.dark{--bg:#111;--panel:#1a1a1a;--txt:#eaeaea;--muted:#bdbdbd;--input-border:#333}
  .btn-add { background: #4caf50; color: #fff; border: 1px solid #388e3c; padding: 7px 10px; border-radius: 8px; white-space: nowrap; font-size:14px; }
  .btn-remove { background: #ef5350; color: #fff; border: 1px solid #c62828; padding: 7px 10px; border-radius: 8px; white-space: nowrap; font-size:14px; }
  .drive-box { border:1px dashed #bbb; background: #fbfbfb; padding:10px; border-radius:8px; margin-top:8px; }
  .num-control { display:flex; align-items:center; gap:6px; }
  .num-control button { width:34px; height:34px; line-height:1; font-size:18px; border-radius:6px; background:#f0f0f0; border:1px solid #cfcfcf; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
  .num-control input { text-align:center; width:72px; padding:6px; border-radius:6px; }
  label{display:block;margin-bottom:6px;font-size:13px}
  .purchase-summary { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
  .purchase-summary .fname { font-weight:700; font-size:16px; }
  .purchase-summary .total { font-weight:700; font-size:16px; }
  .print-total-row { display:none; font-weight:700; }

#btnUncheck {
  white-space: nowrap;
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

</style>
</head>
<body>
<header>
  <div>
    <h1 id="appTitle">Store Inventory ‚Äî Version 3.2.8a</h1>
    <div class="note">Created by Mikell James Sotelo</div>
  </div>
  <div class="controls">
    <button id="btnAdd">‚ûï Add Item</button>
    <button id="btnEditItem" disabled>‚úèÔ∏è Edit Item</button>
    <button id="btnEditCost" disabled>üí∞ Edit Cost</button>
    <button id="btnCategories">üìÇ Categories / Remarks</button>
    <button id="btnGoPurchase">üõí Purchase List</button>
    <button id="btnDataTools">üß∞ Data Tools</button>
    <button id="btnToggleDark">üåô</button>
  </div>
</header>

<section id="productView" class="view active">
  <div class="topbar">
    <div class="search" style="flex:1;gap:8px;align-items:center">
      <input id="search" type="text" placeholder="Search by Item Name or Barcode..." />
      <select id="filterCategory" style="width:180px">
        <option value="">‚Äî All Categories ‚Äî</option>
      </select>
      <select id="filterRemarks" style="width:180px">
        <option value="">‚Äî All Remarks ‚Äî</option>
      </select>
      <button id="btnResetFilters">Reset</button>
      <button id="btnUncheck">üßπ Uncheck All</button>
    </div>
    <label style="width:110px">Rows: <input id="rowsPerPage" type="number" value="9999" min="1" style="width:60px"></label>
  </div>

  <div class="table-wrap" id="tableWrap">
    <table id="productTable">
      <thead>
        <tr>
          <th class="sortable" data-key="category">Category</th>
          <th class="sortable" data-key="barcode">Barcode</th>
          <th class="sortable" data-key="name">Item Name</th>
          <th style="width:110px">Purchase</th>
          <th class="sortable center" data-key="cost">Cost</th>
          <th class="sortable center" data-key="sellPrice">Sell Price</th>
          <th class="center">Suggested Sell Price</th>
          <th class="sortable center" data-key="markup">Mark-Up</th>
          <th class="sortable" data-key="remarks">Remarks</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="purchaseView" class="view">
  <div class="purchase-top no-print">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnBack">‚óÄ Back</button>
      <button id="btnSavePurchase" class="btn-save wide">üíæ Save Purchase List</button>
      <button id="btnExportPurchase">‚¨áÔ∏è Export Purchase Lists</button>
      <button id="btnImportPurchase">‚¨ÜÔ∏è Import Purchase Lists</button>
      <button id="btnUnloadPurchase">üóëÔ∏è Unload List</button>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="savedLists"></select>
      <button id="btnLoadPurchase">‚§µ Load</button>
      <button id="btnPrint">üñ®Ô∏è Print Purchase List</button>
    </div>
  </div>

  <div id="purchaseContainer"></div>
</section>

<section id="categoriesView" class="view">
  <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:10px">
    <button id="btnBackFromCategories">‚óÄ Back</button>
    <div style="flex:1;display:flex;gap:12px">
      <div style="flex:1">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button id="btnAddCategory">‚ûï Add Category</button>
          <button id="btnExportCategories">üíæ Export Categories</button>
          <button id="btnImportCategories">üìÇ Import Categories</button>
        </div>
        <div style="overflow:auto;max-height:48vh">
          <table id="categoriesTable"><thead><tr><th>Category</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div style="flex:1">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button id="btnAddRemark">‚ûï Add Remark</button>
          <button id="btnExportRemarks">üíæ Export Remarks</button>
          <button id="btnImportRemarks">üìÇ Import Remarks</button>
        </div>
        <div style="overflow:auto;max-height:48vh">
          <table id="remarksTable"><thead><tr><th>Remark</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="modalDataTools" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Data Tools</h3>
    <div style="display:flex;flex-direction:column;gap:10px">
      <div style="display:flex;gap:8px">
        <button id="btnBackupLocal">‚¨áÔ∏è Backup localStorage</button>
        <button id="btnRestoreLocal">‚¨ÜÔ∏è Restore from file</button>
        <input id="fileRestore" type="file" accept=".json,.csv" style="display:none">
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button id="btnImportLocal">üìÇ Import CSV</button>
        <button id="btnExportLocal">üíæ Export CSV</button>
      </div>

      <div class="drive-box" id="driveBox">
        <h4>‚òÅÔ∏è Google Drive Sync</h4>
        <div class="drive-controls">
          <button id="btnDriveConnect" disabled>üîó Connect to Drive</button>
          <button id="btnDriveUpload" disabled>‚¨ÜÔ∏è Upload Backup (All)</button>
          <button id="btnDriveLoad" disabled>‚¨áÔ∏è Load Backup (All)</button>
          <div id="driveStatus" class="drive-status-inline">Drive: Not connected</div>
        </div>
        <div class="note" style="margin-top:8px">Drive export/import is system-wide (products, categories, remarks, purchase lists). Connect to enable.</div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="btnResetAll" class="btn-danger">‚ö†Ô∏è Reset all data</button>
        <button id="btnImportLegacy">‚¨ÜÔ∏è Import from older version (CSV)</button>
        <input id="fileImportLegacy" type="file" accept=".csv" style="display:none">
      </div>

      <div style="display:flex;gap:8px">
        <button id="btnCloseDataTools">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="modalItem" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalItemTitle">Add Item</h3>
    <div class="form-grid">
      <div>
        <label>Category</label>
        <select id="itemCategory"></select>
      </div>
      <div>
        <label>Barcode</label>
        <input id="itemBarcode" type="text">
      </div>
      <div style="grid-column:1/3">
        <label>Item Name</label>
        <input id="itemName" type="text">
      </div>

      <div>
        <label>Packs</label>
        <div class="num-control">
          <button type="button" class="num-dec" data-target="itemPacks">‚àí</button>
          <input id="itemPacks" type="number" min="0" value="1">
          <button type="button" class="num-inc" data-target="itemPacks">+</button>
        </div>
      </div>

      <div>
        <label>Pcs per Pack</label>
        <div class="num-control">
          <button type="button" class="num-dec" data-target="itemPcsPerPack">‚àí</button>
          <input id="itemPcsPerPack" type="number" min="1" value="1">
          <button type="button" class="num-inc" data-target="itemPcsPerPack">+</button>
        </div>
      </div>

      <div>
        <label>Cost per Pack</label>
        <input id="itemCostPerPack" type="number" min="0" step="any" value="1">
      </div>
      <div>
        <label>Cost (auto)</label>
        <input id="itemCost" class="borderless" type="number" readonly>
      </div>
      <div>
        <label>Sell Price (manual)</label>
        <input id="itemSellPrice" class="sell-input" type="number" min="0" step="any" value="">
      </div>
      <div>
        <label>Suggested Sell Price (auto)</label>
        <input id="itemSuggested" class="borderless" type="number" readonly>
      </div>
      <div style="grid-column:1/3">
        <label>Remarks</label>
        <select id="itemRemarks"></select>
      </div>
    </div>
    <div class="btn-row">
      <button id="itemCancel">Cancel</button>
      <button id="itemSave" class="btn-save wide">Save</button>
      <button id="itemDelete" class="btn-danger" style="display:none">üóëÔ∏è Delete Item</button>
    </div>
  </div>
</div>

<div id="modalEditCost" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Edit Cost</h3>
    <div class="form-grid">
      <div><label>Packs</label><input id="editPacks" type="number" min="0"></div>
      <div><label>Pcs per Pack</label><input id="editPcsPerPack" type="number" min="1"></div>
      <div><label>Cost per Pack</label><input id="editCostPerPack" type="number" min="0" step="any"></div>
      <div><label>Cost (auto)</label><input id="editCost" class="borderless" type="number" readonly></div>
    </div>
    <div class="btn-row"><button id="editCancel">Cancel</button><button id="editSave">Save Cost</button></div>
  </div>
</div>

<input id="fileInputLocal" type="file" accept="text/csv" style="display:none">
<input id="fileInputCats" type="file" accept="text/csv" style="display:none">
<input id="fileInputRemarks" type="file" accept="text/csv" style="display:none">
<input id="fileInputPurchase" type="file" accept="text/csv" style="display:none">

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
(function(){
/* Constants */
const KEY = 'store_inventory_v3_2_8';
const KEY_CATS = 'store_inventory_categories_v3_2_8';
const KEY_REMARKS = 'store_inventory_remarks_v3_2_8';
const KEY_SAVED_PURCHASES = 'store_inventory_saved_purchase_lists_v3_2_8';

const GOOGLE_API_KEY = 'AIzaSyBQ9QgFBIkvxvHMV-3wUr7qXwitxwBp0Ro';
const GOOGLE_CLIENT_ID = '96651524997-fu2eois3b9geiqdo2js2600hg1mj84p3.apps.googleusercontent.com';
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// === DRIVE INITIALIZATION (v3.2.7 logic, restored) ===
let gapiInited = false;
let gisInited = false;
let tokenClient = null;

function maybeEnableDrive() {
  const btn = document.getElementById("btnDriveConnect");
  const status = document.getElementById("driveStatus");
  if (gapiInited && gisInited) {
    if (btn) btn.disabled = false;
    if (status) status.textContent = "Drive: Ready (not connected)";
  }
}

function gapiLoaded() {
  gapi.load("client", initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: GOOGLE_API_KEY,
    discoveryDocs: DISCOVERY_DOCS,
  });
  gapiInited = true;
  maybeEnableDrive();
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    callback: "",
  });
  gisInited = true;
  maybeEnableDrive();
}

// Load both scripts explicitly and trigger init
window.addEventListener("load", () => {
  const gapiScript = document.createElement("script");
  gapiScript.src = "https://apis.google.com/js/api.js";
  gapiScript.onload = gapiLoaded;
  document.head.appendChild(gapiScript);

  const gisScript = document.createElement("script");
  gisScript.src = "https://accounts.google.com/gsi/client";
  gisScript.onload = gisLoaded;
  document.head.appendChild(gisScript);
});

  
/* Elements */
const productTableBody = document.querySelector('#productTable tbody');
const searchInput = document.getElementById('search');
const filterCategory = document.getElementById('filterCategory');
const filterRemarks = document.getElementById('filterRemarks');
const rowsPerPage = document.getElementById('rowsPerPage');
const tableWrap = document.getElementById('tableWrap');

const btnAdd = document.getElementById('btnAdd');
const btnEditItem = document.getElementById('btnEditItem');
const btnEditCost = document.getElementById('btnEditCost');
const btnUncheck = document.getElementById('btnUncheck');
const btnImportLocal = document.getElementById('btnImportLocal');
const btnExportLocal = document.getElementById('btnExportLocal');
const btnCategories = document.getElementById('btnCategories');
const btnGoPurchase = document.getElementById('btnGoPurchase');
const btnDataTools = document.getElementById('btnDataTools');
const btnToggleDark = document.getElementById('btnToggleDark');

const btnDriveConnect = document.getElementById('btnDriveConnect');
const btnDriveUpload = document.getElementById('btnDriveUpload');
const btnDriveLoad = document.getElementById('btnDriveLoad');
const driveStatusEl = document.getElementById('driveStatus');

const productView = document.getElementById('productView');
const purchaseView = document.getElementById('purchaseView');
const categoriesView = document.getElementById('categoriesView');

const modalItem = document.getElementById('modalItem');
const modalItemTitle = document.getElementById('modalItemTitle');
const itemCategory = document.getElementById('itemCategory');
const itemBarcode = document.getElementById('itemBarcode');
const itemName = document.getElementById('itemName');
const itemPacks = document.getElementById('itemPacks');
const itemPcsPerPack = document.getElementById('itemPcsPerPack');
const itemCostPerPack = document.getElementById('itemCostPerPack');
const itemCost = document.getElementById('itemCost');
const itemSellPrice = document.getElementById('itemSellPrice');
const itemSuggested = document.getElementById('itemSuggested');
const itemRemarks = document.getElementById('itemRemarks');
const itemCancel = document.getElementById('itemCancel');
const itemSave = document.getElementById('itemSave');
const itemDelete = document.getElementById('itemDelete');

const modalEditCost = document.getElementById('modalEditCost');
const editPacks = document.getElementById('editPacks');
const editPcsPerPack = document.getElementById('editPcsPerPack');
const editCostPerPack = document.getElementById('editCostPerPack');
const editCost = document.getElementById('editCost');
const editCancel = document.getElementById('editCancel');
const editSave = document.getElementById('editSave');

const btnBack = document.getElementById('btnBack');
const btnSavePurchase = document.getElementById('btnSavePurchase');
const btnExportPurchase = document.getElementById('btnExportPurchase');
const btnImportPurchase = document.getElementById('btnImportPurchase');
const btnUnloadPurchase = document.getElementById('btnUnloadPurchase');
const savedListsSelect = document.getElementById('savedLists');
const btnLoadPurchase = document.getElementById('btnLoadPurchase');
const btnPrint = document.getElementById('btnPrint');
const purchaseContainer = document.getElementById('purchaseContainer');

const btnBackFromCategories = document.getElementById('btnBackFromCategories');
const btnAddCategory = document.getElementById('btnAddCategory');
const btnExportCategories = document.getElementById('btnExportCategories');
const btnImportCategories = document.getElementById('btnImportCategories');
const categoriesTableBody = document.querySelector('#categoriesTable tbody');

const btnAddRemark = document.getElementById('btnAddRemark');
const btnExportRemarks = document.getElementById('btnExportRemarks');
const btnImportRemarks = document.getElementById('btnImportRemarks');
const remarksTableBody = document.querySelector('#remarksTable tbody');

const modalDataTools = document.getElementById('modalDataTools');
const btnBackupLocal = document.getElementById('btnBackupLocal');
const btnRestoreLocal = document.getElementById('btnRestoreLocal');
const fileRestore = document.getElementById('fileRestore');
const btnResetAll = document.getElementById('btnResetAll');
const btnImportLegacy = document.getElementById('btnImportLegacy');
const fileImportLegacy = document.getElementById('fileImportLegacy');
const btnCloseDataTools = document.getElementById('btnCloseDataTools');

const fileInputLocal = document.getElementById('fileInputLocal');
const fileInputCats = document.getElementById('fileInputCats');
const fileInputRemarks = document.getElementById('fileInputRemarks');
const fileInputPurchase = document.getElementById('fileInputPurchase');

const btnResetFilters = document.getElementById('btnResetFilters');

let products = [];
let categories = [];
let remarks = [];
let savedPurchaseLists = [];
let selectedId = null;
let loadedPurchaseListName = '';
let sortState = { key: null, asc: true };

let gapiInited = false;
let gisInited = false;
let tokenClient = null;

/* Helpers */
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9) }
function saveAll(){ localStorage.setItem(KEY, JSON.stringify(products)); localStorage.setItem(KEY_CATS, JSON.stringify(categories)); localStorage.setItem(KEY_REMARKS, JSON.stringify(remarks)); localStorage.setItem(KEY_SAVED_PURCHASES, JSON.stringify(savedPurchaseLists)); }
function loadAll(){ try{ products = JSON.parse(localStorage.getItem(KEY)) || [] }catch(e){ products = [] } try{ categories = JSON.parse(localStorage.getItem(KEY_CATS)) || [] }catch(e){ categories = [] } try{ remarks = JSON.parse(localStorage.getItem(KEY_REMARKS)) || [] }catch(e){ remarks = [] } try{ savedPurchaseLists = JSON.parse(localStorage.getItem(KEY_SAVED_PURCHASES)) || [] }catch(e){ savedPurchaseLists = [] } }
function computeCost(packs,pcsPerPack,costPerPack){ packs = Number(packs)||0; pcsPerPack = Number(pcsPerPack)||0; costPerPack = Number(costPerPack)||0; if(packs*pcsPerPack === 0) return 0; return costPerPack / (packs * pcsPerPack); }
function computeSuggested(cost){ return (Number(cost)||0) * 1.2; }
function computeMarkup(sell,cost){ return (Number(sell)||0) - (Number(cost)||0); }
function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

/* Renderers */
function renderCategoryOptions(selected){
  const prevCat = filterCategory.value || '';
  filterCategory.innerHTML = '<option value="">‚Äî All Categories ‚Äî</option>';
  itemCategory.innerHTML = '';
  const optNew = document.createElement('option'); optNew.value='__add_new__'; optNew.textContent='‚ûï Add New Category'; itemCategory.appendChild(optNew);
  categories.forEach(c=>{
    const o = document.createElement('option'); o.value=c; o.textContent=c; itemCategory.appendChild(o);
    const opt = document.createElement('option'); opt.value=c; opt.textContent=c; filterCategory.appendChild(opt);
  });
  if(selected) itemCategory.value = selected;
  else if(categories.length) itemCategory.selectedIndex = 1;
  else itemCategory.selectedIndex = 0;
  if(prevCat && Array.from(filterCategory.options).some(o => o.value === prevCat)){
    filterCategory.value = prevCat;
  }
}
function renderRemarksOptions(selected){
  const prevRemarks = filterRemarks.value || '';
  filterRemarks.innerHTML = '<option value="">‚Äî All Remarks ‚Äî</option>';
  itemRemarks.innerHTML = '';
  const optNew = document.createElement('option'); optNew.value='__add_new__'; optNew.textContent='‚ûï Add New Remark'; itemRemarks.appendChild(optNew);
  remarks.forEach(r=>{
    const o = document.createElement('option'); o.value=r; o.textContent=r; itemRemarks.appendChild(o);
    const opt = document.createElement('option'); opt.value=r; opt.textContent=r; filterRemarks.appendChild(opt);
  });
  if(selected) itemRemarks.value = selected;
  else if(remarks.includes('New')) itemRemarks.value = 'New';
  else if(remarks.length) itemRemarks.selectedIndex = 1;
  else itemRemarks.selectedIndex = 0;
  if(prevRemarks && Array.from(filterRemarks.options).some(o => o.value === prevRemarks)){
    filterRemarks.value = prevRemarks;
  }
}
function ensureDefaultRemarks(){ const defaults = ['New','Fast Moving','Discontinued']; defaults.forEach(d=>{ if(!remarks.includes(d)) remarks.unshift(d) }); remarks = [...new Set(remarks)]; }

/* Refresh product table */
function refreshTable(){
  productTableBody.innerHTML = '';
  let q = (searchInput.value || '').trim().toLowerCase();
  let rows = products.slice();
  const catFilter = filterCategory.value;
  const remarksFilter = filterRemarks.value;
  if(catFilter) rows = rows.filter(r => (r.category||'') === catFilter);
  if(remarksFilter) rows = rows.filter(r => (r.remarks||'') === remarksFilter);

  if(sortState.key){ rows.sort((a,b)=>{ let A = a[sortState.key], B = b[sortState.key]; if(typeof A === 'string') A = A.toLowerCase(); if(typeof B === 'string') B = B.toLowerCase(); if(A < B) return sortState.asc ? -1 : 1; if(A > B) return sortState.asc ? 1 : -1; return 0; }); }
  if(q){ rows = rows.filter(it => (it.name||'').toLowerCase().includes(q) || (it.barcode||'').toLowerCase().includes(q) || (it.remarks||'').toLowerCase().includes(q)) }
  const max = Number(rowsPerPage.value) || rows.length;
  rows.slice(0,max).forEach(it=>{
    const tr = document.createElement('tr'); tr.dataset.id = it.id;
    if(it.id === selectedId) tr.classList.add('selected');
    const tdCat = document.createElement('td'); tdCat.textContent = it.category || '';
    const tdBarcode = document.createElement('td'); tdBarcode.textContent = it.barcode || '';
    const tdName = document.createElement('td'); tdName.textContent = it.name || '';
    const tdBtn = document.createElement('td'); tdBtn.style.textAlign='center'; tdBtn.className='touch-check';
    const btn = document.createElement('button');
    btn.textContent = it.checked ? '‚ûñ Remove' : '‚ûï Add';
    btn.title = it.checked ? 'Remove from purchase list' : 'Add to purchase list';
    btn.className = it.checked ? 'btn-remove' : 'btn-add';
    btn.addEventListener('click', e => { e.stopPropagation(); it.checked = !it.checked; saveAll(); refreshTable(); renderPurchaseTable(); });
    tdBtn.appendChild(btn);

    const tdCost = document.createElement('td'); tdCost.className = 'center'; tdCost.textContent = (it.cost===undefined? '' : Number(it.cost).toFixed(2));
    if(Number(it.cost) < 0) tdCost.classList.add('negative');
    const tdSell = document.createElement('td'); tdSell.className = 'center';
    tdSell.textContent = (Number(it.sellPrice) === 0 || it.sellPrice === '' || it.sellPrice === null || it.sellPrice === undefined) ? '' : (Number(it.sellPrice)||0).toFixed(2);
    if(Number(it.sellPrice) < 0) tdSell.classList.add('negative');
    tdSell.classList.add('sell-bold');
    const tdSuggested = document.createElement('td'); tdSuggested.className = 'center'; tdSuggested.textContent = (it.suggestedSellPrice===undefined ? '' : Number(it.suggestedSellPrice).toFixed(2));
    if(Number(it.suggestedSellPrice) < 0) tdSuggested.classList.add('negative');
    const tdMarkup = document.createElement('td'); tdMarkup.className = 'center'; tdMarkup.textContent = (it.markup===undefined ? '' : Number(it.markup).toFixed(2));
    if(Number(it.markup) < 0) tdMarkup.classList.add('negative');
    const tdRemarks = document.createElement('td'); tdRemarks.textContent = it.remarks || '';

    tr.appendChild(tdCat); tr.appendChild(tdBarcode); tr.appendChild(tdName); tr.appendChild(tdBtn);
    tr.appendChild(tdCost); tr.appendChild(tdSell); tr.appendChild(tdSuggested); tr.appendChild(tdMarkup); tr.appendChild(tdRemarks);

    tr.addEventListener('click', (e) => {
      if(e.target.tagName.toLowerCase() === 'button') return;
      selectedId = it.id;
      btnEditCost.disabled = false;
      btnEditItem.disabled = false;
      refreshTable();
    });

    productTableBody.appendChild(tr);
  });
}

/* Purchase rendering */
function renderPurchaseTable(){
  purchaseContainer.innerHTML = '';
  const checked = products.filter(p=>p.checked);
  if(checked.length === 0){ purchaseContainer.innerHTML = '<div class="note">No items selected for purchase.</div>'; return; }
  const total = checked.reduce((acc, it) => {
    const c = (it.costPerPack !== undefined && it.costPerPack !== null && it.costPerPack !== '') ? Number(it.costPerPack) : (it.cost !== undefined ? Number(it.cost) : 0);
    return acc + (isFinite(c) ? c : 0);
  }, 0);
  const summary = document.createElement('div'); summary.className = 'purchase-summary';
  const left = document.createElement('div'); left.className = 'fname'; left.textContent = loadedPurchaseListName || '';
  const right = document.createElement('div'); right.className = 'total'; right.textContent = 'Total: ' + total.toFixed(2);
  summary.appendChild(left); summary.appendChild(right);
  const table = document.createElement('table'); table.id='purchaseTable';
  const thead = document.createElement('thead'); thead.innerHTML = '<tr><th></th><th>Category</th><th>Item Name</th><th>Cost Per Pack</th><th>Notes</th></tr>';
  const tbody = document.createElement('tbody');
  checked.sort((a,b)=>{ const A=(a.category||'').toLowerCase()+'|'+(a.name||'').toLowerCase(); const B=(b.category||'').toLowerCase()+'|'+(b.name||'').toLowerCase(); if(A<B) return -1; if(A>B) return 1; return 0; });
  checked.forEach(it=>{
    const tr = document.createElement('tr'); tr.dataset.barcode = it.barcode || it.id;
    const tdBlank = document.createElement('td'); tdBlank.style.width='36px';
    const tdCat = document.createElement('td'); tdCat.textContent = it.category || '';
    const tdName = document.createElement('td'); tdName.textContent = it.name || '';
    const tdCost = document.createElement('td'); tdCost.textContent = (it.costPerPack!==undefined? Number(it.costPerPack).toFixed(2) : (it.cost!==undefined? Number(it.cost).toFixed(2) : ''));
    const tdNotes = document.createElement('td'); tdNotes.className='notes-td';
    const ta = document.createElement('textarea'); ta.className='note-input'; ta.dataset.barcode = it.barcode || it.id; ta.value = it.notes || '';
    ta.addEventListener('input', ()=>{ const p = products.find(x => (x.barcode||x.id) == ta.dataset.barcode); if(p){ p.notes = ta.value; saveAll(); } });
    const span = document.createElement('div'); span.className='note-print';
    let printed = ''; if(it.remarks) printed += it.remarks; if(it.notes){ if(printed) printed += '\n'+it.notes; else printed = it.notes; }
    span.textContent = printed;
    tdNotes.appendChild(ta); tdNotes.appendChild(span);
    tr.appendChild(tdBlank); tr.appendChild(tdCat); tr.appendChild(tdName); tr.appendChild(tdCost); tr.appendChild(tdNotes);
    tbody.appendChild(tr);
  });
  const trTotal = document.createElement('tr'); trTotal.className = 'print-total-row';
  trTotal.innerHTML = `<td></td><td></td><td style="font-weight:700">TOTAL</td><td style="font-weight:700">${total.toFixed(2)}</td><td></td>`;
  tbody.appendChild(trTotal);
  table.appendChild(thead); table.appendChild(tbody);
  purchaseContainer.appendChild(summary);
  purchaseContainer.appendChild(table);
}

/* CSV helpers (parsing/export) */
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if(lines.length === 0) return [];
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
  return lines.slice(1).map(line => {
    const cols = line.split(',');
    const obj = {};
    headers.forEach((h,i) => obj[h] = (cols[i] || '').trim());
    return obj;
  });
}
function importRowsAndUpsert(rows){
  let updated = 0, added = 0;
  rows.forEach(rw=>{
    const packs = Number(rw.packs) || 0;
    const pcs = Number(rw.pcsperpack) || 0;
    const cpp = Number(rw.costperpack) || 0;
    const costVal = computeCost(packs, pcs, cpp);
    const sell = (rw.sellprice === '' || rw.sellprice === undefined) ? 0 : Number(rw.sellprice) || 0;
    const cat = (rw.category || '').trim();
    const barcode = (rw.barcode || '').trim();
    const name = (rw.name || '').trim();
    const remarksVal = (rw.remarks || '').trim();
    if(!barcode && !name) return;
    if(cat && !categories.includes(cat)) categories.push(cat);
    if(remarksVal && !remarks.includes(remarksVal)) remarks.push(remarksVal);
    let existing = null;
    if(barcode) existing = products.find(p => (p.barcode||'').toString() === barcode);
    if(!existing && name){
      const lowerName = name.toLowerCase();
      existing = products.find(p => ((p.name||'').toLowerCase() === lowerName));
    }
    if(existing){
      existing.category = cat || existing.category;
      existing.barcode = barcode || existing.barcode;
      existing.name = name || existing.name;
      existing.packs = packs || existing.packs;
      existing.pcsPerPack = pcs || existing.pcsPerPack;
      existing.costPerPack = cpp || existing.costPerPack;
      existing.cost = costVal || existing.cost;
      existing.sellPrice = isFinite(sell) ? sell : existing.sellPrice;
      existing.suggestedSellPrice = computeSuggested(existing.cost);
      existing.markup = computeMarkup(existing.sellPrice, existing.cost);
      existing.checked = (String(rw.checked||'').toLowerCase() === 'true') || !!existing.checked;
      existing.notes = (rw.notes !== undefined && rw.notes !== null && rw.notes !== '') ? rw.notes : (existing.notes || '');
      existing.remarks = remarksVal || existing.remarks || '';
      updated++;
    } else {
      const newItem = {
        id: uid(),
        category: cat,
        barcode: barcode,
        name: name,
        packs: packs,
        pcsPerPack: pcs,
        costPerPack: cpp,
        cost: costVal,
        sellPrice: sell,
        suggestedSellPrice: computeSuggested(costVal),
        markup: computeMarkup(sell, costVal),
        checked: (String(rw.checked||'').toLowerCase() === 'true'),
        notes: rw.notes || '',
        remarks: remarksVal || ''
      };
      products.push(newItem);
      added++;
    }
  });
  categories = [...new Set(categories)];
  remarks = [...new Set(remarks)];
  saveAll();
  refreshTable();
  renderCategoriesTable();
  renderRemarksTable();
  populateSavedLists();
  alert('Import completed ‚Äî ' + updated + ' updated, ' + added + ' added.');
  return { updated, added };
}

/* Categories / Remarks renderers */
function renderCategoriesTable(){
  categoriesTableBody.innerHTML = '';
  categories.forEach((c,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(c)}</td><td><button data-i="${i}" class="edit-cat">Edit</button> <button data-i="${i}" class="del-cat">Delete</button></td>`;
    categoriesTableBody.appendChild(tr);
  });
  categoriesTableBody.querySelectorAll('.edit-cat').forEach(btn=>btn.addEventListener('click', ()=>{ const i = Number(btn.dataset.i); const newName = prompt('Edit category', categories[i]); if(newName && newName.trim()){ categories[i] = newName.trim(); saveAll(); renderCategoryOptions(); renderCategoriesTable(); } }));
  categoriesTableBody.querySelectorAll('.del-cat').forEach(btn=>btn.addEventListener('click', ()=>{ const i = Number(btn.dataset.i); if(!confirm('Delete category and remove from products?')) return; const name = categories[i]; categories.splice(i,1); products.forEach(p=>{ if(p.category===name) p.category=''; }); saveAll(); renderCategoryOptions(); renderCategoriesTable(); refreshTable(); }));
}
function renderRemarksTable(){
  remarksTableBody.innerHTML = '';
  remarks.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r)}</td><td><button data-i="${i}" class="edit-remark">Edit</button> <button data-i="${i}" class="del-remark">Delete</button></td>`;
    remarksTableBody.appendChild(tr);
  });
  remarksTableBody.querySelectorAll('.edit-remark').forEach(btn=>btn.addEventListener('click', ()=>{ const i = Number(btn.dataset.i); const newName = prompt('Edit remark', remarks[i]); if(newName && newName.trim()){ remarks[i] = newName.trim(); saveAll(); renderRemarksOptions(); renderRemarksTable(); } }));
  remarksTableBody.querySelectorAll('.del-remark').forEach(btn=>btn.addEventListener('click', ()=>{ const i = Number(btn.dataset.i); if(!confirm('Delete remark?')) return; const name = remarks[i]; remarks.splice(i,1); products.forEach(p=>{ if(p.remarks === name) p.remarks = ''; }); saveAll(); renderRemarksOptions(); renderRemarksTable(); refreshTable(); }));
}

/* Purchase list save/load/export */
function savePurchaseList(){
  let name = prompt('Enter a name for this purchase list:');
  if(!name) return;
  const selected = products.filter(p=>p.checked).map(p=>({ barcode: p.barcode||p.id, notes: p.notes||'', remarks: p.remarks||'' }));
  if(selected.length === 0){ alert('No items selected to save.'); return; }
  savedPurchaseLists.push({ name: name, items: selected, created: Date.now() });
  saveAll(); populateSavedLists(); alert('Purchase list saved.');
}
function populateSavedLists(){
  savedListsSelect.innerHTML = '';
  savedPurchaseLists.forEach((l,i)=>{ const opt = document.createElement('option'); opt.value = i; opt.textContent = l.name + ' (' + new Date(l.created).toLocaleString() + ')'; savedListsSelect.appendChild(opt); });
  if(savedPurchaseLists.length === 0){ const opt = document.createElement('option'); opt.value = ''; opt.textContent = '-- no saved lists --'; savedListsSelect.appendChild(opt); }
}
function loadSelectedPurchaseList(){
  const idx = savedListsSelect.value;
  if(idx === ''){ alert('No saved list selected.'); return; }
  const lists = savedPurchaseLists;
  const sel = lists[Number(idx)];
  if(!sel) return;
  products.forEach(p => p.checked = false);
  sel.items.forEach(it => {
    const p = products.find(x => (x.barcode||x.id) == it.barcode);
    if(p){ p.checked = true; p.notes = it.notes || p.notes; p.remarks = it.remarks || p.remarks; }
  });
  loadedPurchaseListName = sel.name;
  saveAll(); refreshTable(); showView('purchase'); renderPurchaseTable();
  alert('Loaded saved purchase list: ' + sel.name);
}

/* Export / import purchase lists CSV */
function exportPurchaseListsCSV(){
  const lists = savedPurchaseLists;
  if(lists.length === 0){ alert('No saved purchase lists to export.'); return; }
  const hdr = ['name','created','items_json'];
  const lines = [ hdr.join(',') ];
  lists.forEach(l=>{
    const line = [ l.name, l.created, JSON.stringify(l.items).replace(/,/g,';') ];
    lines.push(line.join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'store_purchase_lists_v3_2_8.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function handlePurchaseListsImport(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ try{
    const rows = parseCSV(r.result);
    rows.forEach(rw=>{
      const name = rw.name || ('Imported_'+new Date().toISOString());
      const created = Number(rw.created) || Date.now();
      let items = [];
      if(rw.items_json){
        try{ items = JSON.parse(rw.items_json.replace(/;/g,',')) }catch(err){ try{ items = JSON.parse(rw.items_json) }catch(e){} }
      }
      savedPurchaseLists.push({ name, items, created });
    });
    saveAll(); populateSavedLists(); alert('Imported purchase lists: '+rows.length);
  } catch(err){ alert('Purchase lists import error: '+err.message); } };
  r.readAsText(f); e.target.value = '';
}

/* Auto save & print */
function autoSavePurchaseListWithTimestamp(){
  const timestamp = new Date();
  const pad = n => String(n).padStart(2,'0');
  const name = `Purchase List - ${pad(timestamp.getFullYear())}-${pad(timestamp.getMonth()+1)}-${pad(timestamp.getDate())} ${pad(timestamp.getHours())}:${pad(timestamp.getMinutes())}:${pad(timestamp.getSeconds())}`;
  const selected = products.filter(p=>p.checked).map(p=>({ barcode:p.barcode||p.id, notes:p.notes||'', remarks:p.remarks||'' }));
  if(selected.length === 0) return null;
  savedPurchaseLists.push({ name: name, items: selected, created: Date.now() });
  saveAll(); populateSavedLists();
  return name;
}
function autoSaveAndPrint(){
  document.querySelectorAll('textarea.note-input').forEach(ta=>{
    const p = products.find(x => (x.barcode||x.id) == ta.dataset.barcode);
    if(p){ p.notes = ta.value; }
  });
  saveAll();
  const savedName = autoSavePurchaseListWithTimestamp();
  renderPurchaseTable();
  if(savedName) loadedPurchaseListName = savedName;
  const oldTitle = document.title;
  if(savedName) document.title = savedName;

  setTimeout(()=>{ window.print(); document.title = oldTitle; }, 250);
}

/* Backup / restore */
function backupLocalStorage(){
  const snapshot = { products, categories, remarks, savedPurchaseLists, exportedAt: Date.now() };
  const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'store_inventory_backup_'+(new Date()).toISOString().replace(/[:.]/g,'-')+'.json'; a.click(); URL.revokeObjectURL(a.href);
}
function handleRestoreFile(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ try{
    const obj = JSON.parse(r.result);
    if(obj.products && obj.categories){
      if(!confirm('This will overwrite current data with the restored snapshot. Continue?')) return;
      products = obj.products || [];
      categories = obj.categories || [];
      remarks = obj.remarks || [];
      savedPurchaseLists = obj.savedPurchaseLists || [];
      saveAll(); ensureDefaultRemarks(); renderCategoryOptions(); renderRemarksOptions(); renderCategoriesTable(); renderRemarksTable(); populateSavedLists(); refreshTable(); alert('Restore completed.');
    } else {
      alert('Invalid backup file.');
    }
  } catch(err){ alert('Restore error: '+err.message); } };
  r.readAsText(f); e.target.value = '';
}

/* Categories/remarks import helpers */
function exportCategoriesCSV(){ const hdr=['category']; const lines=[hdr.join(',')]; categories.forEach(c=>lines.push([c].join(','))); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='store_categories_v3_2_8.csv'; a.click(); URL.revokeObjectURL(a.href); }
function handleCategoriesImport(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const rows=parseCSV(r.result); rows.forEach(rw=>{ const name=rw.category||rw.name||''; if(name && !categories.includes(name)) categories.push(name); }); saveAll(); renderCategoryOptions(); renderCategoriesTable(); alert('Imported categories: '+rows.length); } catch(err){ alert('Categories import error: '+err.message); } }; r.readAsText(f); e.target.value=''; }
function exportRemarksCSV(){ const hdr=['remark']; const lines=[hdr.join(',')]; remarks.forEach(r=>lines.push([r].join(','))); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='store_remarks_v3_2_8.csv'; a.click(); URL.revokeObjectURL(a.href); }
function handleRemarksImport(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const rows=parseCSV(r.result); rows.forEach(rw=>{ const name=rw.remark||rw.name||rw.remarks||''; if(name && !remarks.includes(name)) remarks.push(name); }); saveAll(); renderRemarksOptions(); renderRemarksTable(); alert('Imported remarks: '+rows.length); } catch(err){ alert('Remarks import error: '+err.message); } }; r.readAsText(f); e.target.value=''; }

/* Modal helpers */
function showModal(el){ el.style.display = 'flex'; }
function closeModal(el){ el.style.display = 'none'; }

/* Add/Edit item modal handlers */
function openItemModal(mode){
  renderCategoryOptions();
  renderRemarksOptions();
  if(mode === 'add'){
    modalItemTitle.textContent = 'Add Item';
    itemCategory.value = categories.length ? categories[0] : '__add_new__';
    itemBarcode.value = '';
    itemName.value = '';
    itemPacks.value = 1;
    itemPcsPerPack.value = 1;
    itemCostPerPack.value = 1;
    const costVal = computeCost(1,1,1);
    itemCost.value = costVal.toFixed(4);
    itemSuggested.value = computeSuggested(costVal).toFixed(4);
    itemSellPrice.value = '';
    if(!remarks.includes('New')) { remarks.unshift('New'); }
    renderRemarksOptions('New');
    itemSave.dataset.mode = 'add';
    itemDelete.style.display = 'none';
    showModal(modalItem);
  } else {
    const p = products.find(x => x.id === selectedId);
    if(!p) return;
    modalItemTitle.textContent = 'Edit Item';
    renderCategoryOptions(p.category);
    renderRemarksOptions(p.remarks);
    itemCategory.value = p.category || (categories[0] || '');
    itemBarcode.value = p.barcode || '';
    itemName.value = p.name || '';
    itemPacks.value = p.packs || 1;
    itemPcsPerPack.value = p.pcsPerPack || 1;
    itemCostPerPack.value = p.costPerPack || 1;
    const costVal = computeCost(itemPacks.value, itemPcsPerPack.value, itemCostPerPack.value);
    itemCost.value = costVal.toFixed(4);
    itemSuggested.value = computeSuggested(costVal).toFixed(4);
    itemSellPrice.value = (p.sellPrice === undefined || p.sellPrice === null) ? '' : p.sellPrice;
    itemRemarks.value = p.remarks || '';
    itemSave.dataset.mode = 'edit';
    itemDelete.style.display = 'inline-block';
    showModal(modalItem);
  }
}
function saveItemFromModal(){
  const mode = itemSave.dataset.mode || 'add';
  let cat = itemCategory.value === '__add_new__' ? prompt('New category name:') : itemCategory.value;
  if(cat === '__add_new__' || !cat){ alert('Please choose or add a category.'); return; }
  if(!categories.includes(cat)) categories.push(cat);
  let remarkVal = itemRemarks.value === '__add_new__' ? prompt('New remark:') : itemRemarks.value;
  if(remarkVal === '__add_new__' || remarkVal === null) remarkVal = '';
  if(remarkVal && !remarks.includes(remarkVal)) remarks.push(remarkVal);
  const barcode = itemBarcode.value.trim();
  const name = itemName.value.trim();
  const packs = Number(itemPacks.value) || 0;
  const pcs = Number(itemPcsPerPack.value) || 0;
  const cpp = Number(itemCostPerPack.value) || 0;
  const sell = (itemSellPrice.value === '' ? 0 : Number(itemSellPrice.value)) || 0;
  const costVal = computeCost(packs, pcs, cpp);
  const suggested = computeSuggested(costVal);
  if(mode === 'add'){
    const it = { id: uid(), category: cat, barcode: barcode, name: name, packs: packs, pcsPerPack: pcs, costPerPack: cpp, cost: costVal, sellPrice: (itemSellPrice.value === '' ? '' : sell), suggestedSellPrice: suggested, markup: computeMarkup(sell, costVal), checked: false, notes: '', remarks: remarkVal || '' };
    products.push(it);
  } else {
    const p = products.find(x => x.id === selectedId);
    if(!p) return;
    p.category = cat;
    p.barcode = barcode;
    p.name = name;
    p.packs = packs;
    p.pcsPerPack = pcs;
    p.costPerPack = cpp;
    p.cost = costVal;
    p.sellPrice = (itemSellPrice.value === '' ? '' : sell);
    p.suggestedSellPrice = suggested;
    p.markup = computeMarkup(sell, costVal);
    p.remarks = remarkVal || '';
  }
  categories = [...new Set(categories)];
  remarks = [...new Set(remarks)];
  saveAll();
  closeModal(modalItem);
  selectedId = null;
  btnEditItem.disabled = true; btnEditCost.disabled = true;
  renderCategoryOptions(); renderRemarksOptions();
  renderCategoriesTable(); renderRemarksTable();
  refreshTable();
}
function deleteItemFromModal(){
  if(!selectedId) return;
  if(!confirm('Are you sure you want to delete this item?')) return;
  const idx = products.findIndex(p => p.id === selectedId);
  if(idx === -1){ alert('Item not found'); return; }
  products.splice(idx,1);
  saveAll();
  closeModal(modalItem);
  selectedId = null;
  btnEditItem.disabled = true; btnEditCost.disabled = true;
  renderCategoriesTable(); renderRemarksTable();
  refreshTable();
  alert('Item deleted.');
}

/* Edit cost modal */
function openEditCostModal(){
  const p = products.find(x => x.id === selectedId);
  if(!p) return;
  editPacks.value = p.packs || 0;
  editPcsPerPack.value = p.pcsPerPack || 1;
  editCostPerPack.value = p.costPerPack || 1;
  editCost.value = computeCost(editPacks.value, editPcsPerPack.value, editCostPerPack.value).toFixed(4);
  showModal(modalEditCost);
}
function saveEditedCost(){
  const p = products.find(x => x.id === selectedId);
  if(!p) return;
  const packs = Number(editPacks.value) || 0;
  const pcs = Number(editPcsPerPack.value) || 0;
  const cpp = Number(editCostPerPack.value) || 0;
  const costVal = computeCost(packs, pcs, cpp);
  p.packs = packs; p.pcsPerPack = pcs; p.costPerPack = cpp; p.cost = costVal;
  p.suggestedSellPrice = computeSuggested(costVal);
  p.markup = computeMarkup(p.sellPrice||0, costVal);
  saveAll();
  refreshTable();
  closeModal(modalEditCost);
}

/* Bind events - note: numeric +/- global listener is outside (so works always) */
function bindEvents(){
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.key;
      if(sortState.key === key) sortState.asc = !sortState.asc;
      else { sortState.key = key; sortState.asc = true; }
      refreshTable();
    });
  });

  searchInput.addEventListener('input', ()=>refreshTable());
  searchInput.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ e.preventDefault(); refreshTable(); setTimeout(()=>{ searchInput.select(); }, 50); } });
  filterCategory.addEventListener('change', ()=>refreshTable());
  filterRemarks.addEventListener('change', ()=>refreshTable());
  rowsPerPage.addEventListener('change', ()=>refreshTable());

  btnAdd.addEventListener('click', ()=>openItemModal('add'));
  itemCancel.addEventListener('click', ()=>closeModal(modalItem));
  itemSave.addEventListener('click', saveItemFromModal);
  itemDelete.addEventListener('click', deleteItemFromModal);

  itemCategory.addEventListener('change', ()=>{ if(itemCategory.value === '__add_new__'){ const n = prompt('New category name:'); if(n && n.trim()){ addCategory(n.trim()); } else renderCategoryOptions(); }});
  itemRemarks.addEventListener('change', ()=>{ if(itemRemarks.value === '__add_new__'){ const n = prompt('New remark:'); if(n && n.trim()){ addRemark(n.trim()); } else renderRemarksOptions(); }});

  [itemPacks,itemPcsPerPack,itemCostPerPack].forEach(el=>el.addEventListener('input', ()=>{
    const costVal = computeCost(itemPacks.value, itemPcsPerPack.value, itemCostPerPack.value);
    itemCost.value = costVal.toFixed(4);
    itemSuggested.value = computeSuggested(costVal).toFixed(4);
  }));

  btnEditItem.addEventListener('click', ()=>{ if(!selectedId) return; openItemModal('edit'); });
  btnEditCost.addEventListener('click', ()=>{ if(!selectedId) return; openEditCostModal(); });
  editCancel.addEventListener('click', ()=>closeModal(modalEditCost));
  editSave.addEventListener('click', saveEditedCost);
  [editPacks, editPcsPerPack, editCostPerPack].forEach(el=>el.addEventListener('input', ()=>{ editCost.value = computeCost(editPacks.value, editPcsPerPack.value, editCostPerPack.value).toFixed(4); }));

  btnResetFilters.addEventListener('click', ()=>{
    searchInput.value = '';
    filterCategory.value = '';
    filterRemarks.value = '';
    refreshTable();
  });

  btnUncheck.addEventListener('click', ()=>{ if(!confirm('Uncheck ALL items?')) return; products.forEach(p=>p.checked=false); saveAll(); refreshTable(); renderPurchaseTable(); });

  btnImportLocal.addEventListener('click', ()=> fileInputLocal.click());
  fileInputLocal.addEventListener('change', handleFileImportLocal);
  btnExportLocal.addEventListener('click', exportCSVLocal);

  btnCategories.addEventListener('click', ()=> showView('categories'));
  btnBackFromCategories.addEventListener('click', ()=> showView('product'));
  btnAddCategory.addEventListener('click', ()=>{ const n = prompt('New category name:'); if(n && n.trim()) addCategory(n.trim()); });
  btnExportCategories.addEventListener('click', exportCategoriesCSV);
  btnImportCategories.addEventListener('click', ()=> fileInputCats.click());
  fileInputCats.addEventListener('change', handleCategoriesImport);

  btnAddRemark.addEventListener('click', ()=>{ const n = prompt('New remark:'); if(n && n.trim()) addRemark(n.trim()); });
  btnExportRemarks.addEventListener('click', exportRemarksCSV);
  btnImportRemarks.addEventListener('click', ()=> fileInputRemarks.click());
  fileInputRemarks.addEventListener('change', handleRemarksImport);

  btnGoPurchase.addEventListener('click', ()=> showView('purchase'));
  btnBack.addEventListener('click', ()=> showView('product'));
  btnPrint.addEventListener('click', autoSaveAndPrint);
  btnSavePurchase.addEventListener('click', savePurchaseList);
  btnLoadPurchase.addEventListener('click', loadSelectedPurchaseList);
  btnExportPurchase.addEventListener('click', exportPurchaseListsCSV);
  btnImportPurchase.addEventListener('click', ()=> fileInputPurchase.click());
  fileInputPurchase.addEventListener('change', handlePurchaseListsImport);
  btnUnloadPurchase.addEventListener('click', ()=>{ if(!loadedPurchaseListName) { alert('No purchase list loaded.'); return; } if(!confirm('Unload/clear the currently loaded purchase list?')) return; products.forEach(p => p.checked = false); loadedPurchaseListName = ''; saveAll(); refreshTable(); renderPurchaseTable(); alert('Purchase list unloaded.'); });

  btnDataTools.addEventListener('click', ()=> showModal(modalDataTools));
  btnCloseDataTools.addEventListener('click', ()=> closeModal(modalDataTools));
  btnBackupLocal.addEventListener('click', backupLocalStorage);
  btnRestoreLocal.addEventListener('click', ()=> fileRestore.click());
  fileRestore.addEventListener('change', handleRestoreFile);
  btnResetAll.addEventListener('click', ()=>{ if(!confirm('Reset ALL data? This cannot be undone.')) return; products=[]; categories=[]; remarks=[]; savedPurchaseLists=[]; saveAll(); ensureDefaultRemarks(); renderCategoryOptions(); renderRemarksOptions(); refreshTable(); renderCategoriesTable(); renderRemarksTable(); alert('All data reset.');});
  btnImportLegacy.addEventListener('click', ()=> fileImportLegacy.click());
  fileImportLegacy.addEventListener('change', handleLegacyImport);

  btnToggleDark.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); adjustTableHeight(); });

  btnDriveConnect.addEventListener('click', handleDriveConnect);
  btnDriveUpload.addEventListener('click', handleDriveExportAll);
  btnDriveLoad.addEventListener('click', handleDriveImportAll);

  document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'e'){ e.preventDefault(); exportCSVLocal(); } });
}

/* Global numeric +/- handler (must be outside bindEvents so it always works) */
document.addEventListener('click', (e) => {
  const target = e.target;
  if (!target) return;
  if (target.classList && (target.classList.contains('num-inc') || target.classList.contains('num-dec'))) {
    const isInc = target.classList.contains('num-inc');
    const id = target.dataset.target;
    const input = document.getElementById(id);
    if (!input) return;
    let val = Number(input.value || 0);
    if (isInc) val++;
    else {
      if (id === 'itemPcsPerPack' || id === 'editPcsPerPack') val = Math.max(1, val - 1);
      else val = Math.max(0, val - 1);
    }
    input.value = val;
    input.dispatchEvent(new Event('input'));
  }
});

/* UI helpers */
function adjustTableHeight(){
  const headerHeight = document.querySelector('header').offsetHeight || 120;
  const topbars = document.querySelector('.topbar').offsetHeight || 60;
  const reserved = headerHeight + topbars + 140;
  const h = Math.max(300, window.innerHeight - reserved);
  tableWrap.style.maxHeight = h + 'px';
}
window.addEventListener('resize', adjustTableHeight);

/* Drive init (kept but simplified) */
function maybeInitGapiAndGis(){
  if(!GOOGLE_API_KEY || !GOOGLE_CLIENT_ID){
    if(driveStatusEl) driveStatusEl.textContent = 'Drive: Add API_KEY & CLIENT_ID';
    if(btnDriveConnect) btnDriveConnect.disabled = true;
    if(btnDriveUpload) btnDriveUpload.disabled = true;
    if(btnDriveLoad) btnDriveLoad.disabled = true;
    return;
  }
  try {
    gapi.load('client', async () => {
      try {
        await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: DISCOVERY_DOCS });
        gapiInited = true;
      } catch(err){ console.error('gapi init',err); }
    });
    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: SCOPES, callback: (resp)=>{ if(resp && resp.access_token){ if(driveStatusEl) driveStatusEl.textContent='Drive: Connected'; if(btnDriveUpload) btnDriveUpload.disabled=false; if(btnDriveLoad) btnDriveLoad.disabled=false; } } });
    gisInited = true;
  } catch(e){ console.warn('drive init skipped', e); }
}

/* Init */
function populateSavedLists(){ savedListsSelect.innerHTML = ''; savedPurchaseLists.forEach((l,i)=>{ const opt = document.createElement('option'); opt.value = i; opt.textContent = l.name + ' (' + new Date(l.created).toLocaleString() + ')'; savedListsSelect.appendChild(opt); }); if(savedPurchaseLists.length === 0){ const opt = document.createElement('option'); opt.value = ''; opt.textContent = '-- no saved lists --'; savedListsSelect.appendChild(opt); } }
function addCategory(name){ if(!name) return; if(!categories.includes(name)){ categories.push(name); saveAll(); renderCategoryOptions(name); renderCategoriesTable(); } }
function addRemark(name){ if(!name) return; if(!remarks.includes(name)){ remarks.push(name); saveAll(); renderRemarksOptions(name); renderRemarksTable(); } }

function showView(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  if(name === 'product') productView.classList.add('active');
  if(name === 'purchase') purchaseView.classList.add('active');
  if(name === 'categories') categoriesView.classList.add('active');
  adjustTableHeight();
  if(name === 'purchase') renderPurchaseTable();
}

/* Load / init */
function init(){
  loadAll();
  ensureDefaultRemarks();
  renderCategoryOptions();
  renderRemarksOptions();
  renderCategoriesTable();
  renderRemarksTable();
  populateSavedLists();
  bindEvents();
  adjustTableHeight();
  refreshTable();
  maybeInitGapiAndGis();
  // default light mode -> do not add body.dark
  document.title = 'Store Inventory ‚Äî Version 3.2.8a (Numeric Controls Fixed)';
}
window.addEventListener('load', init);

/* Minimal stubs for missing functions used above (to avoid errors if not implemented) */
function handleFileImportLocal(e){ const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const rows=parseCSV(r.result); importRowsAndUpsert(rows);}catch(err){ alert('Import error: '+err.message);} }; r.readAsText(f); e.target.value=''; }
function exportCSVLocal(){ const hdr = ['category','barcode','name','packs','pcsperpack','costperpack','cost','sellprice','suggestedsellprice','markup','checked','remarks','notes']; const lines=[hdr.join(',')]; products.forEach(p=>{ const sellVal = (p.sellPrice === '' || p.sellPrice === null || p.sellPrice === undefined) ? '' : p.sellPrice; const cols=[p.category||'',p.barcode||'',p.name||'',p.packs||0,p.pcsPerPack||0,p.costPerPack||0,p.cost||0,sellVal,p.suggestedSellPrice||'',p.markup||'',p.checked||false,p.remarks||'',p.notes||'']; lines.push(cols.map(c=>String(c).replace(/,/g,'')).join(',')); }); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='store_inventory_v3_2_8.csv'; a.click(); URL.revokeObjectURL(a.href); }

function handleCategoriesImport(e){ /* simplified */ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const rows=parseCSV(r.result); rows.forEach(rw=>{ const name=rw.category||rw.name||''; if(name && !categories.includes(name)) categories.push(name); }); saveAll(); renderCategoryOptions(); renderCategoriesTable(); alert('Imported categories: '+rows.length); }catch(err){ alert('Categories import error: '+err.message);} }; r.readAsText(f); e.target.value=''; }
function handleRemarksImport(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const rows=parseCSV(r.result); rows.forEach(rw=>{ const name=rw.remark||rw.name||rw.remarks||''; if(name && !remarks.includes(name)) remarks.push(name); }); saveAll(); renderRemarksOptions(); renderRemarksTable(); alert('Imported remarks: '+rows.length); }catch(err){ alert('Remarks import error: '+err.message);} }; r.readAsText(f); e.target.value=''; }

})();
// ‚úÖ Legacy Import Handler (placeholder to prevent crash)
function handleLegacyImport() {
  const fileInput = document.getElementById('fileImportLegacy');
  if (!fileInput) return;
  fileInput.value = '';
  fileInput.click();

  fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const csv = evt.target.result;
        alert("Legacy import completed (mock function). Please ensure your CSV format is compatible with v3.x structure.");
        // TODO: Map CSV columns to current format if needed
      } catch (err) {
        alert("Error importing legacy data: " + err.message);
      }
    };
    reader.readAsText(file);
  };
}
// ‚úÖ Drive Connect Handler (safe fallback)
function handleDriveConnect() {
  try {
    if (typeof gapi === 'undefined' || typeof google === 'undefined') {
      alert("Google API not loaded. Please ensure you're online.");
      return;
    }

    // Initialize token client if not already done
    if (!tokenClient) {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            driveStatusEl.textContent = "Drive: Connected";
            btnDriveUpload.disabled = false;
            btnDriveLoad.disabled = false;
            alert("‚úÖ Connected to Google Drive successfully!");
          } else {
            alert("Drive connection failed. Try again.");
          }
        }
      });
    }

    // Request access token (triggers Google sign-in popup)
    tokenClient.requestAccessToken();

  } catch (err) {
    console.error(err);
    alert("Drive initialization error: " + err.message);
  }
}
// ‚úÖ Drive Export All Handler (safe fallback)
function handleDriveExportAll() {
  try {
    if (!gapi || !gapi.client || !gapi.client.drive) {
      alert("‚ö†Ô∏è Google Drive not initialized. Please connect first.");
      return;
    }

    const fileContent = JSON.stringify({
      products,
      categories,
      remarks,
      savedPurchaseLists,
      timestamp: new Date().toISOString()
    }, null, 2);

    const fileName = `StoreInventoryBackup_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
    const blob = new Blob([fileContent], { type: "application/json" });
    const metadata = {
      name: fileName,
      mimeType: "application/json"
    };

    const accessToken = gapi.client.getToken().access_token;
    fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: { "Authorization": "Bearer " + accessToken },
      body: new Blob([
        `--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n${fileContent}\r\n--foo_bar_baz--`
      ], { type: "multipart/related; boundary=foo_bar_baz" })
    }).then(r => {
      if (r.ok) {
        alert("‚úÖ Backup uploaded to Google Drive successfully!");
      } else {
        alert("‚ö†Ô∏è Upload failed. Please try again.");
      }
    }).catch(err => alert("Drive upload error: " + err.message));
  } catch (err) {
    alert("Error exporting to Drive: " + err.message);
  }
}
// ‚úÖ Drive Import All Handler (safe fallback)
function handleDriveImportAll() {
  try {
    if (!gapi || !gapi.client || !gapi.client.drive) {
      alert("‚ö†Ô∏è Google Drive not initialized. Please connect first.");
      return;
    }

    const accessToken = gapi.client.getToken().access_token;
    const query = "name contains 'StoreInventoryBackup_' and mimeType='application/json'";

    gapi.client.drive.files.list({
      q: query,
      fields: "files(id, name, modifiedTime)",
      orderBy: "modifiedTime desc",
      pageSize: 1
    }).then((response) => {
      const files = response.result.files;
      if (!files || files.length === 0) {
        alert("‚ö†Ô∏è No backup files found in your Drive.");
        return;
      }

      const file = files[0];
      fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
        headers: { "Authorization": "Bearer " + accessToken }
      })
      .then(res => res.json())
      .then(data => {
        if (data.products && data.categories && data.remarks && data.savedPurchaseLists) {
          products = data.products;
          categories = data.categories;
          remarks = data.remarks;
          savedPurchaseLists = data.savedPurchaseLists;
          saveAll();
          alert(`‚úÖ Backup "${file.name}" restored successfully!`);
          location.reload();
        } else {
          alert("‚ö†Ô∏è Invalid backup format.");
        }
      })
      .catch(err => alert("Drive download error: " + err.message));
    }).catch(err => alert("Drive listing error: " + err.message));
  } catch (err) {
    alert("Error importing from Drive: " + err.message);
  }
}

/* Close the main script properly */
</script>

<!-- Drive Init Helper (appended by assistant - fixes Connect button enabling only) -->
<script>
(function(){
  // Do not change existing variables or functions. This helper only ensures Google APIs are
  // initialized and enables the Connect button when ready, without altering UI or layout.

  // Guard: if elements or Google config not present, do nothing.
  function safeGet(id){ try{ return document.getElementById(id); }catch(e){return null;} }
  const btnDriveConnect = safeGet('btnDriveConnect');
  const btnDriveUpload = safeGet('btnDriveUpload');
  const btnDriveLoad = safeGet('btnDriveLoad');
  const driveStatusEl = safeGet('driveStatus');

  // If button missing, abort silently.
  if(!btnDriveConnect || !driveStatusEl) return;

  // Internal flags (do not overwrite global flags if they exist)
  try {
    window._assistant_drive_helper = window._assistant_drive_helper || {};
    const helper = window._assistant_drive_helper;
    helper.gapiInited = helper.gapiInited || false;
    helper.gisInited = helper.gisInited || false;
  } catch(e) {
    // ignore
  }

  function maybeEnableDriveUI(){
    // prefer using existing globals if present
    const gapiInited = (typeof window.gapiInited !== 'undefined') ? window.gapiInited : window._assistant_drive_helper.gapiInited;
    const gisInited = (typeof window.gisInited !== 'undefined') ? window.gisInited : window._assistant_drive_helper.gisInited;

    if(gapiInited && gisInited){
      btnDriveConnect.disabled = false;
      if(driveStatusEl && driveStatusEl.textContent && driveStatusEl.textContent.indexOf('Ready') === -1) {
        driveStatusEl.textContent = 'Drive: Ready (not connected)';
      }
    } else {
      // keep disabled until both ready
      btnDriveConnect.disabled = true;
      if(driveStatusEl && driveStatusEl.textContent && driveStatusEl.textContent.indexOf('Initializing') === -1) {
        driveStatusEl.textContent = 'Drive: Initializing...';
      }
    }
  }

  // Setup handlers when gapi and gis scripts load (works whether they are loaded at top or later)
  function onGapiLoaded(){
    if(!window.gapi) return;
    // initialize client if not already
    if(typeof window.gapi.client !== 'undefined' && !window._assistant_drive_helper.gapiInited){
      try{
        window.gapi.client.init({ apiKey: (window.GOOGLE_API_KEY || window.GOOGLE_API_KEY || ''), discoveryDocs: (window.DISCOVERY_DOCS || window.DISCOVERY_DOCS || []) })
          .then(function(){
            window._assistant_drive_helper.gapiInited = true;
            if(typeof window.gapiInited === 'undefined') window.gapiInited = true;
            maybeEnableDriveUI();
          })
          .catch(function(err){
            console.warn('assistant helper: gapi.client.init error', err);
            // still attempt to enable UI later
            maybeEnableDriveUI();
          });
      }catch(e){
        console.warn('assistant helper gapi init exception', e);
        maybeEnableDriveUI();
      }
    } else {
      // mark as inited if client already has token or initialized elsewhere
      if(window.gapi && window.gapi.client) {
        window._assistant_drive_helper.gapiInited = true;
        if(typeof window.gapiInited === 'undefined') window.gapiInited = true;
      }
      maybeEnableDriveUI();
    }
  }

  function onGisLoaded(){
    if(!window.google || !google.accounts || !google.accounts.oauth2) {
      // still set flag and try later
      window._assistant_drive_helper.gisInited = true;
      if(typeof window.gisInited === 'undefined') window.gisInited = true;
      maybeEnableDriveUI();
      return;
    }
    // ensure token client exists or create a safe one (without changing app tokenClient if present)
    try{
      if(!window.tokenClient){
        // create a non-intrusive tokenClient that won't override app behavior; callback left minimal
        window.tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: (window.GOOGLE_CLIENT_ID || window.GOOGLE_CLIENT_ID || ''),
          scope: (window.SCOPES || window.SCOPES || 'https://www.googleapis.com/auth/drive.file'),
          callback: function(resp){
            // set gapi token if available
            if(resp && resp.access_token && window.gapi && window.gapi.client){
              try{ window.gapi.client.setToken({access_token: resp.access_token}); }catch(e){}
              driveStatusEl.textContent = 'Drive: Connected';
              if(btnDriveUpload) btnDriveUpload.disabled = false;
              if(btnDriveLoad) btnDriveLoad.disabled = false;
            }
          }
        });
      }
      window._assistant_drive_helper.gisInited = true;
      if(typeof window.gisInited === 'undefined') window.gisInited = true;
    }catch(e){
      console.warn('assistant helper: gis init error', e);
      window._assistant_drive_helper.gisInited = true;
      if(typeof window.gisInited === 'undefined') window.gisInited = true;
    }
    maybeEnableDriveUI();
  }

  // If scripts already present, attach onload callbacks or call directly
  (function attachOrLoadScripts(){
    // If apis script already loaded and gapi exists, call handler; otherwise set onload
    const existingGapi = window.gapi;
    if(existingGapi){
      try{ onGapiLoaded(); }catch(e){}
    } else {
      // find script tag
      const s = document.querySelector('script[src*="apis.google.com/js/api.js"]');
      if(s){
        s.addEventListener('load', onGapiLoaded);
      } else {
        // create script tag but do not duplicate if already being added elsewhere
        const n = document.createElement('script');
        n.src = 'https://apis.google.com/js/api.js';
        n.onload = onGapiLoaded;
        n.onerror = function(){ console.warn('assistant helper: failed to load api.js'); maybeEnableDriveUI(); };
        document.head.appendChild(n);
      }
    }

    const existingGis = window.google && window.google.accounts;
    if(existingGis){
      try{ onGisLoaded(); }catch(e){}
    } else {
      const s2 = document.querySelector('script[src*="accounts.google.com/gsi/client"]');
      if(s2){
        s2.addEventListener('load', onGisLoaded);
      } else {
        const n2 = document.createElement('script');
        n2.src = 'https://accounts.google.com/gsi/client';
        n2.onload = onGisLoaded;
        n2.onerror = function(){ console.warn('assistant helper: failed to load gis client'); maybeEnableDriveUI(); };
        document.head.appendChild(n2);
      }
    }
  })();

  // Also attempt to enable UI periodically for a short time in case loading already happened earlier
  let tries = 0;
  const intId = setInterval(function(){
    maybeEnableDriveUI();
    tries++;
    if(tries > 10 || (window._assistant_drive_helper.gapiInited && window._assistant_drive_helper.gisInited)) {
      clearInterval(intId);
    }
  }, 700);
// Force-enable Drive Connect if everything is ready
setTimeout(() => {
  try {
    if (window.gapi && window.gapi.client && window.google && window.google.accounts) {
      const btn = document.getElementById("btnDriveConnect");
      if (btn) btn.disabled = false;
      const status = document.getElementById("driveStatus");
      if (status) status.textContent = "Drive: Ready (connected scripts)";
      console.log("‚úÖ Drive scripts ready ‚Äî Connect button enabled.");
    }
  } catch(e) {
    console.warn("Drive enable fallback error:", e);
  }
}, 2000);

})();
</script>
<!-- End Drive Init Helper -->

</body>
</html>
